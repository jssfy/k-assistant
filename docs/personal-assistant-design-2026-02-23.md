# ä¸ªäººåŠ©æ‰‹ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ

> æ—¥æœŸ: 2026-02-23
> ç›®æ ‡: å•å°æœåŠ¡å™¨éƒ¨ç½²çš„ä¸ªäºº AI åŠ©æ‰‹ï¼Œæ”¯æŒå¤šä¿¡æ¯æºé—®ç­”ã€å®šæ—¶ä»»åŠ¡ã€å¤šæ¨¡å‹åˆ‡æ¢ã€æŒä¹…è®°å¿†

---

## æ ¸å¿ƒç»“è®º

1. **æ²¡æœ‰ä¸€ä¸ªç°æˆé¡¹ç›®å®Œå…¨è¦†ç›–æ‰€æœ‰éœ€æ±‚**ï¼Œä½†é€šè¿‡ç»„åˆ 2-3 ä¸ªæˆç†Ÿç»„ä»¶å¯ä»¥å¿«é€Ÿæ­å»º
2. **æ¨èæ¶æ„**: FastAPI è‡ªç ”æ ¸å¿ƒ + LiteLLMï¼ˆå¤šæ¨¡å‹ç½‘å…³ï¼‰+ Mem0ï¼ˆè®°å¿†å±‚ï¼‰+ APSchedulerï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
3. **æ›¿ä»£æ–¹æ¡ˆ**: å¦‚æœæ¥å—æ›´é‡çš„éƒ¨ç½²ï¼ŒDify + å®šåˆ¶æ’ä»¶èƒ½è¦†ç›– 80% éœ€æ±‚ï¼Œä½†çµæ´»æ€§å—é™
4. **å•å°æœåŠ¡å™¨èµ„æº**: ä»…ç”¨äº‘ç«¯ LLM â†’ 4æ ¸8GB è¶³å¤Ÿï¼›åŠ æœ¬åœ° 7B æ¨¡å‹ â†’ 16-32GB

---

## ä¸€ã€éœ€æ±‚ä¸è¡Œä¸šç°çŠ¶å¯¹æ¯”

### ä½ çš„å››å¤§æ ¸å¿ƒéœ€æ±‚

| éœ€æ±‚ | æè¿° |
|------|------|
| **å¤šæºé—®ç­”** | æ¥å…¥ä¸åŒä¿¡æ¯æºï¼ˆWebæœç´¢ã€çŸ¥è¯†åº“ã€APIã€æ•°æ®åº“ç­‰ï¼‰å›ç­”é—®é¢˜ |
| **å®šæ—¶ä»»åŠ¡** | è‡ªç„¶è¯­è¨€åˆ›å»º/æ›´æ–°å®šæ—¶ä»»åŠ¡ï¼Œå¯æ“ä½œå·¥å…·ï¼Œè¾“å‡ºåˆ°é£ä¹¦ç­‰æ¸ é“ |
| **å¤šæ¨¡å‹åˆ‡æ¢** | çµæ´»åˆ‡æ¢ä¸åŒ LLMï¼ˆClaude/GPT/æœ¬åœ°æ¨¡å‹ç­‰ï¼‰ |
| **æŒä¹…è®°å¿†** | è·¨ä¼šè¯è®°å¿†ç”¨æˆ·åå¥½ã€å†å²ä¸Šä¸‹æ–‡ã€ä»»åŠ¡çŠ¶æ€ |

### è¡Œä¸šäº§å“åŠŸèƒ½è¦†ç›–åº¦

| äº§å“ | å¤šæºé—®ç­” | å®šæ—¶ä»»åŠ¡ | å¤šæ¨¡å‹ | è®°å¿† | é£ä¹¦é›†æˆ | å•æœºéƒ¨ç½² |
|------|:--------:|:--------:|:------:|:----:|:--------:|:--------:|
| **Dify** | âœ… RAG+å·¥å…· | âœ… åŸç”Ÿcron | âœ… | âš ï¸ ä¼šè¯çº§ | âš ï¸ webhook | âœ… è¾ƒé‡(11å®¹å™¨) |
| **Open WebUI** | âœ… RAG | âŒ | âœ… | âš ï¸ åŸºç¡€ | âŒ | âœ… è½»é‡ |
| **LobeChat** | âœ… æ’ä»¶ | âŒ | âœ… | ğŸ”¨ å¼€å‘ä¸­ | âŒ | âœ… è½»é‡ |
| **n8n** | âœ… å·¥ä½œæµ | âœ… åŸç”Ÿcron | âœ… AIèŠ‚ç‚¹ | âŒ | âœ… HTTPèŠ‚ç‚¹ | âœ… ä¸­ç­‰ |
| **Letta/MemGPT** | âš ï¸ å·¥å…· | âŒ | âœ… | âœ… æœ€å¼º | âŒ | âœ… |
| **Mem0** | âŒ çº¯è®°å¿†å±‚ | âŒ | âŒ | âœ… ä¼˜ç§€ | âŒ | âœ… |
| **OpenClaw** | âœ… | âœ… | âœ… | âš ï¸ | âœ… åŸç”Ÿ | âœ… æè½» |

### å…³é”®å‘ç°

- **å®šæ—¶ä»»åŠ¡æ˜¯æœ€å¤§ç¼ºå£**: å¤§å¤šæ•° AI èŠå¤©æ¡†æ¶éƒ½ä¸æ”¯æŒåŸç”Ÿå®šæ—¶ä»»åŠ¡ï¼Œåªæœ‰ Difyã€n8nã€OpenClaw æœ‰
- **è®°å¿†ç³»ç»Ÿå·®å¼‚å·¨å¤§**: ä»ç®€å•çš„ä¼šè¯å†å²åˆ° MemGPT çš„åˆ†å±‚è‡ªç¼–è¾‘è®°å¿†ï¼Œæˆç†Ÿåº¦å·®å¼‚å¤§
- **é£ä¹¦é›†æˆç¨€ç¼º**: é™¤ OpenClaw å¤–ï¼Œå…¶ä»–éƒ½éœ€è¦é€šè¿‡ webhook è‡ªè¡Œå¯¹æ¥
- **MCP å·²æˆä¸ºå·¥å…·è°ƒç”¨æ ‡å‡†**: æœˆ SDK ä¸‹è½½é‡ 9700 ä¸‡+ï¼Œæ‰€æœ‰ä¸»æµ AI å…¬å¸é‡‡ç”¨

---

## äºŒã€æ¶æ„è®¾è®¡

### æ¨èæ–¹æ¡ˆ: è‡ªç ”æ ¸å¿ƒ + æˆç†Ÿç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·æ¥å…¥å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ Web Chat â”‚  â”‚ é£ä¹¦Bot   â”‚  â”‚ API/CLI  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜               â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                      â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              FastAPI æ ¸å¿ƒæœåŠ¡                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚            å¯¹è¯ç®¡ç†å™¨ (Router)                 â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - æ„å›¾è¯†åˆ« (é—®ç­”/ä»»åŠ¡ç®¡ç†/é—²èŠ)               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - ä¸Šä¸‹æ–‡æ³¨å…¥ (è®°å¿†æ£€ç´¢)                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - å“åº”è·¯ç”± (å›å¤ç”¨æˆ·/æ‰§è¡Œå·¥å…·/åˆ›å»ºä»»åŠ¡)        â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                      â”‚                             â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚  â”‚  â–¼         â–¼         â–¼         â–¼          â–¼       â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚ â”‚è®°å¿†â”‚  â”‚å·¥å…·å±‚ â”‚  â”‚å®šæ—¶å™¨ â”‚  â”‚æ¨¡å‹å±‚ â”‚  â”‚è¾“å‡ºå±‚  â”‚   â”‚   â”‚
â”‚  â”‚ â”‚ç®¡ç†â”‚  â”‚(MCP) â”‚  â”‚è°ƒåº¦  â”‚  â”‚è·¯ç”±  â”‚  â”‚è·¯ç”±   â”‚   â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚         â”‚         â”‚         â”‚          â”‚         â”‚
â”‚       â–¼         â–¼         â–¼         â–¼          â–¼         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Mem0   â”‚ â”‚ MCP  â”‚ â”‚APSched â”‚ â”‚LiteLLM â”‚ â”‚ Feishu â”‚   â”‚
â”‚  â”‚(è®°å¿†)  â”‚ â”‚Serverâ”‚ â”‚ uler   â”‚ â”‚ Proxy  â”‚ â”‚ SDK    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                   â”‚         â”‚                    â”‚
â”‚       â–¼                   â–¼         â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚           PostgreSQL + pgvector          â”‚             â”‚
â”‚  â”‚  - å¯¹è¯å†å²  - è®°å¿†å­˜å‚¨  - ä»»åŠ¡é…ç½®       â”‚             â”‚
â”‚  â”‚  - å‘é‡ç´¢å¼•  - ç”¨æˆ·æ•°æ®  - æ‰§è¡Œæ—¥å¿—       â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å„å±‚èŒè´£

#### 1. ç”¨æˆ·æ¥å…¥å±‚
- **Web Chat**: ç®€å•çš„å‰ç«¯é¡µé¢ï¼ŒåŸºäº WebSocket å®ç°æµå¼å¯¹è¯
- **é£ä¹¦ Bot**: é€šè¿‡é£ä¹¦å¼€æ”¾å¹³å°çš„äº‹ä»¶è®¢é˜…æ¥æ”¶æ¶ˆæ¯ï¼Œé€šè¿‡ API å‘é€å›å¤
- **API/CLI**: RESTful API ä¾›ç¨‹åºè°ƒç”¨ï¼ŒCLI ä¾›æœ¬åœ°ä½¿ç”¨

#### 2. æ ¸å¿ƒæœåŠ¡ (FastAPI)
- **å¯¹è¯ç®¡ç†å™¨**: ç»Ÿä¸€å…¥å£ï¼Œå¤„ç†æ‰€æœ‰å¯¹è¯è¯·æ±‚
  - ä»è®°å¿†å±‚æ£€ç´¢ç›¸å…³ä¸Šä¸‹æ–‡æ³¨å…¥ prompt
  - è¯†åˆ«ç”¨æˆ·æ„å›¾ï¼ˆçº¯é—®ç­” / åˆ›å»ºä»»åŠ¡ / ä¿®æ”¹ä»»åŠ¡ / æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ï¼‰
  - è°ƒç”¨ LLM ç”Ÿæˆå›å¤ï¼Œæ”¯æŒ function calling / tool use
- **æ¶ˆæ¯æ ¼å¼ç»Ÿä¸€**: ä¸åŒæ¥å…¥æ¸ é“çš„æ¶ˆæ¯ç»Ÿä¸€ä¸ºå†…éƒ¨æ ¼å¼

#### 3. è®°å¿†ç®¡ç† (Mem0)
- **å·¥ä½œåŸç†**: æ¯æ¬¡å¯¹è¯åï¼ŒMem0 è‡ªåŠ¨ä»å¯¹è¯ä¸­æå–åŸå­äº‹å®ï¼Œä¸å·²æœ‰è®°å¿†æ¯”å¯¹åå†³å®š ADD/UPDATE/DELETE/NOOP
- **ä¸‰ç±»è®°å¿†**:
  - **è¯­ä¹‰è®°å¿†** (Semantic): ç”¨æˆ·åå¥½ã€äº‹å®çŸ¥è¯†ï¼ˆ"æˆ‘ç”¨çš„æ˜¯ Mac"ã€"æˆ‘å…³æ³¨ AI é¢†åŸŸ"ï¼‰
  - **æƒ…æ™¯è®°å¿†** (Episodic): å†å²äº¤äº’æ‘˜è¦ï¼ˆ"ä¸Šæ¬¡è®¨è®ºäº† Redis æ–¹æ¡ˆ"ï¼‰
  - **ç¨‹åºè®°å¿†** (Procedural): è¡Œä¸ºè§„åˆ™ï¼ˆ"ç”¨æˆ·å–œæ¬¢ç®€æ´å›å¤"ã€"åˆ†ææŠ¥å‘Šè¦å‘é£ä¹¦"ï¼‰
- **æ£€ç´¢**: æ¯æ¬¡å¯¹è¯å‰ï¼Œç”¨å½“å‰é—®é¢˜åšè¯­ä¹‰æœç´¢ + å…ƒæ•°æ®è¿‡æ»¤ï¼Œå¬å› top-K ç›¸å…³è®°å¿†æ³¨å…¥ system prompt
- **å­˜å‚¨**: pgvector å­˜å‘é‡ï¼ŒPostgreSQL å­˜å…ƒæ•°æ®

#### 4. å·¥å…·å±‚ (MCP)
- åŸºäº MCP (Model Context Protocol) æ ‡å‡†æ¥å…¥å„ç±»å·¥å…·
- **å†…ç½®å·¥å…·**: Web æœç´¢ã€å¤©æ°”æŸ¥è¯¢ã€è®¡ç®—å™¨ã€ä»£ç æ‰§è¡Œ
- **è‡ªå®šä¹‰å·¥å…·**: é€šè¿‡ MCP Server è§„èŒƒç¼–å†™ï¼Œçƒ­æ’æ‹”
- **ä¿¡æ¯æº**: æ¯ä¸ªä¿¡æ¯æºå°è£…ä¸ºä¸€ä¸ª MCP Toolï¼ŒLLM é€šè¿‡ function calling æŒ‰éœ€è°ƒç”¨

#### 5. å®šæ—¶ä»»åŠ¡è°ƒåº¦ (APScheduler)
```
ç”¨æˆ·: "æ¯å‘¨ä¸€æ—©ä¸Š9ç‚¹å¸®æˆ‘æœç´¢AIé¢†åŸŸçš„æœ€æ–°è®ºæ–‡ï¼Œæ€»ç»“åå‘é£ä¹¦"
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM è§£æ (Function Calling)         â”‚
â”‚  â†’ cron: "0 9 * * 1"                â”‚
â”‚  â†’ task_type: "search_and_summarize" â”‚
â”‚  â†’ tools: ["web_search"]            â”‚
â”‚  â†’ output: {type: "feishu",          â”‚
â”‚             target: "group_xxx"}     â”‚
â”‚  â†’ prompt: "æœç´¢æœ¬å‘¨AIé¢†åŸŸæœ€æ–°è®ºæ–‡..." â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  APScheduler æ³¨å†Œ CronTrigger        â”‚
â”‚  â†’ æŒä¹…åŒ–åˆ° PostgreSQL               â”‚
â”‚  â†’ å…³è” task_config (JSONB)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ (è§¦å‘æ—¶)
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Task Runner                         â”‚
â”‚  1. åŠ è½½ task_config                  â”‚
â”‚  2. æ£€ç´¢ç›¸å…³è®°å¿†æ³¨å…¥ä¸Šä¸‹æ–‡             â”‚
â”‚  3. è°ƒç”¨ LLM + å·¥å…·æ‰§è¡Œä»»åŠ¡            â”‚
â”‚  4. é€šè¿‡è¾“å‡ºè·¯ç”±å‘é€ç»“æœ               â”‚
â”‚  5. è®°å½•æ‰§è¡Œæ—¥å¿—                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 6. æ¨¡å‹è·¯ç”± (LiteLLM)
- **ç»Ÿä¸€æ¥å£**: æ‰€æœ‰ LLM è°ƒç”¨é€šè¿‡ LiteLLM ä»£ç†ï¼Œå¯¹å¤–æš´éœ² OpenAI å…¼å®¹ API
- **æ”¯æŒçš„åç«¯**:
  - äº‘ç«¯: OpenAI, Anthropic, Google Gemini, DeepSeek, é€šä¹‰åƒé—®
  - æœ¬åœ°: Ollama (llama, qwen, deepseek ç­‰)
- **è·¯ç”±ç­–ç•¥**:
  - é»˜è®¤æ¨¡å‹: ç”¨æˆ·çº§é…ç½®ï¼Œæ¯ä¸ªç”¨æˆ·å¯è®¾ç½®åå¥½æ¨¡å‹
  - ä»»åŠ¡çº§åˆ‡æ¢: å®šæ—¶ä»»åŠ¡å¯æŒ‡å®šä½¿ç”¨ç‰¹å®šæ¨¡å‹
  - é™çº§ç­–ç•¥: ä¸»æ¨¡å‹ä¸å¯ç”¨æ—¶è‡ªåŠ¨åˆ‡æ¢å¤‡é€‰æ¨¡å‹
- **æˆæœ¬è¿½è¸ª**: è‡ªåŠ¨è®°å½•æ¯æ¬¡è°ƒç”¨çš„ token ç”¨é‡å’Œè´¹ç”¨

#### 7. è¾“å‡ºè·¯ç”±
- **é£ä¹¦**: é€šè¿‡é£ä¹¦ Bot API å‘é€æ–‡æœ¬/å¯Œæ–‡æœ¬/å¡ç‰‡æ¶ˆæ¯
- **Web**: WebSocket æ¨é€åˆ°å‰ç«¯
- **Webhook**: é€šç”¨ HTTP å›è°ƒï¼Œæ”¯æŒå¯¹æ¥ä»»æ„å¹³å°
- **é‚®ä»¶**: SMTP å‘é€ï¼ˆå¯é€‰ï¼‰

---

## ä¸‰ã€æ•°æ®åº“è®¾è®¡

### æ ¸å¿ƒè¡¨ç»“æ„

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name        VARCHAR(100) NOT NULL,
    config      JSONB DEFAULT '{}',  -- åå¥½æ¨¡å‹ã€é»˜è®¤è¾“å‡ºæ¸ é“ç­‰
    created_at  TIMESTAMPTZ DEFAULT NOW()
);

-- å¯¹è¯è¡¨
CREATE TABLE conversations (
    id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id     UUID REFERENCES users(id),
    title       VARCHAR(200),
    model       VARCHAR(50),          -- ä½¿ç”¨çš„æ¨¡å‹
    channel     VARCHAR(20),          -- web/feishu/api
    created_at  TIMESTAMPTZ DEFAULT NOW(),
    updated_at  TIMESTAMPTZ DEFAULT NOW()
);

-- æ¶ˆæ¯è¡¨
CREATE TABLE messages (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    conversation_id UUID REFERENCES conversations(id),
    role            VARCHAR(20) NOT NULL,  -- system/user/assistant/tool
    content         TEXT,
    tool_calls      JSONB,                 -- function calling è®°å½•
    token_usage     JSONB,                 -- {prompt_tokens, completion_tokens}
    created_at      TIMESTAMPTZ DEFAULT NOW()
);

-- å®šæ—¶ä»»åŠ¡è¡¨
CREATE TABLE scheduled_tasks (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id         UUID REFERENCES users(id),
    name            VARCHAR(200) NOT NULL,
    description     TEXT,                   -- ç”¨æˆ·åŸå§‹æè¿°
    cron_expression VARCHAR(50) NOT NULL,
    timezone        VARCHAR(50) DEFAULT 'Asia/Shanghai',
    is_active       BOOLEAN DEFAULT TRUE,
    -- ä»»åŠ¡é…ç½®
    task_config     JSONB NOT NULL,         -- {prompt, tools, model, output_routing}
    -- task_config ç¤ºä¾‹:
    -- {
    --   "prompt": "æœç´¢æœ¬å‘¨AIé¢†åŸŸæœ€æ–°è®ºæ–‡å¹¶æ€»ç»“",
    --   "tools": ["web_search", "summarize"],
    --   "model": "claude-sonnet-4-6",
    --   "output": {"type": "feishu", "target": "group_webhook_url"},
    --   "context_query": "AIè®ºæ–‡è¿½è¸ª"  -- ç”¨äºæ£€ç´¢ç›¸å…³è®°å¿†
    -- }
    next_run_at     TIMESTAMPTZ,
    last_run_at     TIMESTAMPTZ,
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW()
);

-- ä»»åŠ¡æ‰§è¡Œæ—¥å¿—
CREATE TABLE task_executions (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    task_id         UUID REFERENCES scheduled_tasks(id),
    status          VARCHAR(20) NOT NULL,  -- running/success/failed
    started_at      TIMESTAMPTZ NOT NULL,
    finished_at     TIMESTAMPTZ,
    -- æ‰§è¡Œè¯¦æƒ…
    llm_messages    JSONB,                 -- å®Œæ•´ LLM å¯¹è¯è®°å½•
    tool_calls      JSONB,                 -- å·¥å…·è°ƒç”¨è®°å½•
    result          TEXT,                   -- æœ€ç»ˆè¾“å‡ºå†…å®¹
    output_status   JSONB,                 -- å„è¾“å‡ºæ¸ é“çš„å‘é€çŠ¶æ€
    token_usage     JSONB,
    error           TEXT
);

-- è®°å¿†è¡¨ (Mem0 ç®¡ç†ï¼Œæ­¤å¤„ä¸ºå‚è€ƒç»“æ„)
CREATE TABLE memories (
    id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id     UUID REFERENCES users(id),
    content     TEXT NOT NULL,              -- è®°å¿†å†…å®¹
    category    VARCHAR(20),               -- semantic/episodic/procedural
    metadata    JSONB DEFAULT '{}',
    embedding   vector(1024),              -- pgvector
    created_at  TIMESTAMPTZ DEFAULT NOW(),
    updated_at  TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_memories_embedding ON memories USING ivfflat (embedding vector_cosine_ops);
```

---

## å››ã€æŠ€æœ¯é€‰å‹æ€»ç»“

| å±‚ | æŠ€æœ¯é€‰æ‹© | ç†ç”± |
|----|----------|------|
| **Web æ¡†æ¶** | FastAPI | å¼‚æ­¥åŸç”Ÿã€LLMç”Ÿæ€æœ€å¥½ã€ç±»å‹å®‰å…¨ |
| **æ•°æ®åº“** | PostgreSQL 16 + pgvector | ä¸€ä¸ªæœåŠ¡æå®šå…³ç³»æ•°æ®+å‘é‡æœç´¢ |
| **è®°å¿†å±‚** | Mem0 (self-hosted) | æˆç†Ÿçš„æå–/æ›´æ–°æµæ°´çº¿ï¼ŒApache 2.0ï¼Œæ¯” MemGPT æ›´ç®€å• |
| **LLM ç½‘å…³** | LiteLLM Proxy | 100+ providerï¼ŒOpenAI å…¼å®¹ï¼Œæˆæœ¬è¿½è¸ª |
| **å®šæ—¶è°ƒåº¦** | APScheduler | è¿›ç¨‹å†…è°ƒåº¦ï¼ŒSQLAlchemy jobstore æŒä¹…åŒ–ï¼Œå¤Ÿç”¨ä¸”ç®€å• |
| **å·¥å…·åè®®** | MCP (Model Context Protocol) | è¡Œä¸šæ ‡å‡†ï¼Œç”Ÿæ€ä¸°å¯Œï¼Œçƒ­æ’æ‹” |
| **é£ä¹¦é›†æˆ** | é£ä¹¦å¼€æ”¾å¹³å° SDK | äº‹ä»¶è®¢é˜…+æ¶ˆæ¯APIï¼Œæ”¯æŒå¡ç‰‡æ¶ˆæ¯ |
| **å‰ç«¯** | ç®€å• React/Vue SPA | ä»…ä½œç®¡ç†é¢æ¿å’Œ Web èŠå¤©å…¥å£ |
| **å®¹å™¨åŒ–** | Docker Compose | å•æœºéƒ¨ç½²æœ€ä½³å®è·µ |

---

## äº”ã€é¡¹ç›®ç»“æ„

```
k-assistant/
â”‚
â”‚  ======================== é¡¹ç›®æ ¹ç›®å½• ========================
â”‚
â”œâ”€â”€ docker-compose.yml              # å®¹å™¨ç¼–æ’: app + postgres + litellm
â”œâ”€â”€ Dockerfile                      # åº”ç”¨é•œåƒæ„å»º
â”œâ”€â”€ pyproject.toml                  # Python ä¾èµ–ç®¡ç† (uv/poetry)
â”œâ”€â”€ alembic.ini                     # æ•°æ®åº“è¿ç§»é…ç½®
â”œâ”€â”€ litellm_config.yaml             # LiteLLM æ¨¡å‹è·¯ç”±é…ç½®
â”œâ”€â”€ .env.example                    # ç¯å¢ƒå˜é‡æ¨¡æ¿
â”‚
â”‚  ======================== æ•°æ®åº“è¿ç§» ========================
â”‚
â”œâ”€â”€ alembic/
â”‚   â”œâ”€â”€ env.py                      # è¿ç§»ç¯å¢ƒé…ç½®ï¼Œè¯»å– app/db çš„ Base.metadata
â”‚   â””â”€â”€ versions/                   # è‡ªåŠ¨ç”Ÿæˆçš„è¿ç§»è„šæœ¬
â”‚       â””â”€â”€ 001_initial.py
â”‚
â”‚  ======================== æ ¸å¿ƒåº”ç”¨ ========================
â”‚
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py                     # FastAPI å…¥å£
â”‚   â”‚                               #   - æ³¨å†Œæ‰€æœ‰ router
â”‚   â”‚                               #   - lifespan: å¯åŠ¨/å…³é—­ schedulerã€db pool
â”‚   â”‚                               #   - æŒ‚è½½ middleware
â”‚   â”‚
â”‚   â”œâ”€â”€ config.py                   # é…ç½®ç®¡ç† (pydantic-settings)
â”‚   â”‚                               #   - Settings ç±»: DB_URL, LITELLM_URL, FEISHU_*
â”‚   â”‚                               #   - ä» .env æˆ–ç¯å¢ƒå˜é‡è¯»å–
â”‚   â”‚                               #   - æ¯ä¸ªé…ç½®é¡¹æœ‰ç±»å‹å’Œé»˜è®¤å€¼
â”‚   â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ•°æ®åº“å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚   â”‚
â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”œâ”€â”€ session.py              # AsyncSession å·¥å‚
â”‚   â”‚   â”‚                           #   - create_async_engine (è¿æ¥æ± é…ç½®)
â”‚   â”‚   â”‚                           #   - async_sessionmaker
â”‚   â”‚   â”‚                           #   - get_db() ä¾èµ–æ³¨å…¥å‡½æ•°
â”‚   â”‚   â””â”€â”€ base.py                 # DeclarativeBase åŸºç±»
â”‚   â”‚                               #   - ç»Ÿä¸€çš„ Base ç±»ï¼Œæ‰€æœ‰ model ç»§æ‰¿è‡ªå®ƒ
â”‚   â”‚                               #   - å…¬å…±å­—æ®µ mixin (id, created_at, updated_at)
â”‚   â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ORM æ¨¡å‹å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚   â”‚
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ __init__.py             # å¯¼å‡ºæ‰€æœ‰ modelï¼Œä¾› Alembic è‡ªåŠ¨æ£€æµ‹
â”‚   â”‚   â”œâ”€â”€ user.py                 # User æ¨¡å‹
â”‚   â”‚   â”‚                           #   - id, name, config(JSONB: åå¥½æ¨¡å‹ã€æ—¶åŒºç­‰)
â”‚   â”‚   â”œâ”€â”€ conversation.py         # Conversation æ¨¡å‹
â”‚   â”‚   â”‚                           #   - id, user_id, title, model, channel, summary
â”‚   â”‚   â”œâ”€â”€ message.py              # Message æ¨¡å‹
â”‚   â”‚   â”‚                           #   - id, conversation_id, role, content
â”‚   â”‚   â”‚                           #   - tool_calls(JSONB), token_usage(JSONB)
â”‚   â”‚   â”œâ”€â”€ scheduled_task.py       # ScheduledTask æ¨¡å‹
â”‚   â”‚   â”‚                           #   - id, user_id, name, cron_expression, timezone
â”‚   â”‚   â”‚                           #   - task_config(JSONB): prompt, tools, model, output
â”‚   â”‚   â”‚                           #   - is_active, next_run_at, last_run_at
â”‚   â”‚   â””â”€â”€ task_execution.py       # TaskExecution æ¨¡å‹
â”‚   â”‚                               #   - id, task_id, status, started_at, finished_at
â”‚   â”‚                               #   - result, error, token_usage(JSONB)
â”‚   â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Pydantic Schema å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚   â”‚  (è¯·æ±‚æ ¡éªŒ + å“åº”åºåˆ—åŒ–ï¼Œä¸ ORM æ¨¡å‹è§£è€¦)
â”‚   â”‚
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”œâ”€â”€ chat.py                 # å¯¹è¯ç›¸å…³ schema
â”‚   â”‚   â”‚                           #   - ChatRequest: model, messages[], stream
â”‚   â”‚   â”‚                           #   - ChatResponse: message, usage, conversation_id
â”‚   â”‚   â”‚                           #   - MessageOut: æ¶ˆæ¯å“åº”æ ¼å¼
â”‚   â”‚   â”œâ”€â”€ task.py                 # å®šæ—¶ä»»åŠ¡ schema
â”‚   â”‚   â”‚                           #   - TaskCreate: name, description(è‡ªç„¶è¯­è¨€)
â”‚   â”‚   â”‚                           #   - TaskUpdate: cron, is_active, task_config
â”‚   â”‚   â”‚                           #   - TaskOut: ä»»åŠ¡è¯¦æƒ… + æœ€è¿‘æ‰§è¡ŒçŠ¶æ€
â”‚   â”‚   â”‚                           #   - TaskExecutionOut: æ‰§è¡Œè®°å½•
â”‚   â”‚   â”œâ”€â”€ memory.py               # è®°å¿† schema
â”‚   â”‚   â”‚                           #   - MemoryOut: content, category, relevance_score
â”‚   â”‚   â”‚                           #   - MemoryQuery: query, top_k, category_filter
â”‚   â”‚   â””â”€â”€ common.py               # é€šç”¨ schema
â”‚   â”‚                               #   - PageParams: page, page_size
â”‚   â”‚                               #   - PageResponse[T]: items, total, page
â”‚   â”‚                               #   - ErrorResponse: code, message, detail
â”‚   â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚   â”‚
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ chat.py                 # å¯¹è¯ç¼–æ’å™¨ (æ ¸å¿ƒå…¥å£)
â”‚   â”‚   â”‚                           #   - async def chat(user_id, message, model, conv_id)
â”‚   â”‚   â”‚                           #     1. åŠ è½½/åˆ›å»º conversation
â”‚   â”‚   â”‚                           #     2. è°ƒ memory.recall() æ£€ç´¢ç›¸å…³è®°å¿†
â”‚   â”‚   â”‚                           #     3. æ„å»º system prompt (åŸºç¡€ + è®°å¿† + å·¥å…·å®šä¹‰)
â”‚   â”‚   â”‚                           #     4. è°ƒ llm.complete() è·å–å›å¤
â”‚   â”‚   â”‚                           #     5. è‹¥å« tool_calls â†’ è°ƒ tools.execute() â†’ å›åˆ° 4
â”‚   â”‚   â”‚                           #     6. æŒä¹…åŒ– messages
â”‚   â”‚   â”‚                           #     7. å¼‚æ­¥è°ƒ memory.process() æå–æ–°è®°å¿†
â”‚   â”‚   â”‚                           #     8. è¿”å›å“åº”
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ llm.py                  # LLM å®¢æˆ·ç«¯å°è£…
â”‚   â”‚   â”‚                           #   - LLMClient ç±»ï¼ŒåŒ…è£… openai.AsyncOpenAI
â”‚   â”‚   â”‚                           #   - base_url æŒ‡å‘ LiteLLM Proxy
â”‚   â”‚   â”‚                           #   - complete(): æ™®é€šè¯·æ±‚
â”‚   â”‚   â”‚                           #   - stream(): SSE æµå¼è¯·æ±‚
â”‚   â”‚   â”‚                           #   - è‡ªåŠ¨æºå¸¦ tool definitions
â”‚   â”‚   â”‚                           #   - è®°å½• token usage
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ memory.py               # è®°å¿†ç®¡ç† (Mem0 å°è£…)
â”‚   â”‚   â”‚                           #   - MemoryManager ç±»
â”‚   â”‚   â”‚                           #   - recall(user_id, query, top_k) â†’ æ£€ç´¢ç›¸å…³è®°å¿†
â”‚   â”‚   â”‚                           #   - process(user_id, messages) â†’ ä»å¯¹è¯æå–/æ›´æ–°è®°å¿†
â”‚   â”‚   â”‚                           #   - list(user_id, category) â†’ æŸ¥çœ‹æ‰€æœ‰è®°å¿†
â”‚   â”‚   â”‚                           #   - delete(memory_id) â†’ æ‰‹åŠ¨åˆ é™¤é”™è¯¯è®°å¿†
â”‚   â”‚   â”‚                           #   - å†…éƒ¨è°ƒ Mem0 çš„ add/search/delete API
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ tools.py                # MCP å·¥å…·ç®¡ç†
â”‚   â”‚   â”‚                           #   - ToolRegistry ç±»
â”‚   â”‚   â”‚                           #   - discover() â†’ æ‰«æ mcp_servers/ï¼ŒåŠ è½½å¯ç”¨å·¥å…·
â”‚   â”‚   â”‚                           #   - get_definitions() â†’ è¿”å› OpenAI function æ ¼å¼çš„å·¥å…·åˆ—è¡¨
â”‚   â”‚   â”‚                           #   - execute(tool_name, params) â†’ è°ƒç”¨å¯¹åº” MCP Server
â”‚   â”‚   â”‚                           #   - ç®¡ç† MCP client session ç”Ÿå‘½å‘¨æœŸ
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ prompt.py               # Prompt æ¨¡æ¿ç®¡ç†
â”‚   â”‚   â”‚                           #   - build_system_prompt(user, memories, tools) â†’ str
â”‚   â”‚   â”‚                           #   - TEMPLATES: åŸºç¡€äººè®¾ã€è®°å¿†æ³¨å…¥æ ¼å¼ã€ä»»åŠ¡æ‰§è¡ŒæŒ‡ä»¤
â”‚   â”‚   â”‚                           #   - æ”¯æŒæŒ‰åœºæ™¯åˆ‡æ¢ (å¯¹è¯ / å®šæ—¶ä»»åŠ¡ / æ„å›¾è¯†åˆ«)
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ intent.py               # æ„å›¾è¯†åˆ«
â”‚   â”‚                               #   - classify(message) â†’ IntentType
â”‚   â”‚                               #   - IntentType: CHAT / CREATE_TASK / UPDATE_TASK
â”‚   â”‚                               #                 / QUERY_TASK / SWITCH_MODEL / ...
â”‚   â”‚                               #   - è½»é‡å®ç°: å…³é”®è¯ + LLM function calling
â”‚   â”‚                               #   - å†³å®šæ¶ˆæ¯èµ° chat æµç¨‹è¿˜æ˜¯ task ç®¡ç†æµç¨‹
â”‚   â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å®šæ—¶ä»»åŠ¡è°ƒåº¦ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚   â”‚
â”‚   â”œâ”€â”€ scheduler/
â”‚   â”‚   â”œâ”€â”€ engine.py               # è°ƒåº¦å¼•æ“
â”‚   â”‚   â”‚                           #   - åˆå§‹åŒ– AsyncIOScheduler
â”‚   â”‚   â”‚                           #   - SQLAlchemyJobStore æŒä¹…åŒ–åˆ° PostgreSQL
â”‚   â”‚   â”‚                           #   - start() / shutdown()
â”‚   â”‚   â”‚                           #   - add_task(scheduled_task) â†’ æ³¨å†Œ cron job
â”‚   â”‚   â”‚                           #   - remove_task(task_id) â†’ ç§»é™¤ job
â”‚   â”‚   â”‚                           #   - update_task(task_id, changes) â†’ æ›´æ–° trigger
â”‚   â”‚   â”‚                           #   - sync_from_db() â†’ å¯åŠ¨æ—¶ä» DB æ¢å¤æ‰€æœ‰æ´»è·ƒä»»åŠ¡
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ task_runner.py          # ä»»åŠ¡æ‰§è¡Œå™¨ (æ¯æ¬¡è§¦å‘æ—¶è°ƒç”¨)
â”‚   â”‚   â”‚                           #   - async def run(task_id):
â”‚   â”‚   â”‚                           #     1. ä» DB åŠ è½½ task_config
â”‚   â”‚   â”‚                           #     2. è°ƒ memory.recall() è·å–ä»»åŠ¡ç›¸å…³è®°å¿†
â”‚   â”‚   â”‚                           #     3. æ„å»º prompt (task_config.prompt + è®°å¿†ä¸Šä¸‹æ–‡)
â”‚   â”‚   â”‚                           #     4. è°ƒ llm.complete() æ‰§è¡Œ (å¯èƒ½å¤šè½® tool_call)
â”‚   â”‚   â”‚                           #     5. è°ƒ output.dispatch() å‘é€ç»“æœ
â”‚   â”‚   â”‚                           #     6. å†™å…¥ task_executions æ—¥å¿—
â”‚   â”‚   â”‚                           #     7. æ›´æ–° scheduled_tasks.last_run_at
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ nl_parser.py            # è‡ªç„¶è¯­è¨€ â†’ å®šæ—¶ä»»åŠ¡è§£æ
â”‚   â”‚                               #   - parse(user_message) â†’ ParsedTask
â”‚   â”‚                               #   - ParsedTask: cron_expression, prompt, tools,
â”‚   â”‚                               #                 output_config, model
â”‚   â”‚                               #   - å®ç°: LLM function callingï¼Œå®šä¹‰ create_task å‡½æ•°
â”‚   â”‚                               #   - å¤„ç†æ¨¡ç³Šè¡¨è¿°: "æ¯å¤©æ—©ä¸Š" â†’ "0 9 * * *"
â”‚   â”‚                               #   - å¤„ç†æ›´æ–°æŒ‡ä»¤: "æŠŠè®ºæ–‡æ¨é€æ”¹æˆæ¯å‘¨ä¸‰" â†’ ä¿®æ”¹å·²æœ‰ä»»åŠ¡
â”‚   â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è¾“å…¥æ¸ é“ (æ¥æ”¶æ¶ˆæ¯) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚   â”‚
â”‚   â”œâ”€â”€ channels/
â”‚   â”‚   â”œâ”€â”€ base.py                 # æ¸ é“æŠ½è±¡åŸºç±»
â”‚   â”‚   â”‚                           #   - class BaseChannel(ABC):
â”‚   â”‚   â”‚                           #     - parse_message(raw) â†’ InternalMessage
â”‚   â”‚   â”‚                           #     - send_response(conv_id, content) â†’ None
â”‚   â”‚   â”‚                           #   - InternalMessage: user_id, text, channel, metadata
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ web.py                  # WebSocket æ¸ é“
â”‚   â”‚   â”‚                           #   - /ws/{conversation_id} WebSocket endpoint
â”‚   â”‚   â”‚                           #   - æ¥æ”¶ç”¨æˆ·æ¶ˆæ¯ â†’ InternalMessage â†’ core.chat
â”‚   â”‚   â”‚                           #   - æµå¼å›å†™: LLM stream chunk â†’ ws.send_text
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ feishu.py               # é£ä¹¦æ¸ é“ (æ¥æ”¶)
â”‚   â”‚                               #   - /webhook/feishu POST endpoint
â”‚   â”‚                               #   - éªŒè¯é£ä¹¦ç­¾å (Verification Token / Encrypt Key)
â”‚   â”‚                               #   - è§£æäº‹ä»¶: im.message.receive_v1
â”‚   â”‚                               #   - æå– user_id (open_id), text â†’ InternalMessage
â”‚   â”‚                               #   - è°ƒ core.chat â†’ é€šè¿‡ output/feishu.py å›å¤
â”‚   â”‚                               #   - å¤„ç†é£ä¹¦ç‰¹æœ‰: @æœºå™¨äººã€ç¾¤èŠ/ç§èŠåŒºåˆ†
â”‚   â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è¾“å‡ºæ¸ é“ (å‘é€æ¶ˆæ¯) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚   â”‚
â”‚   â”œâ”€â”€ output/
â”‚   â”‚   â”œâ”€â”€ base.py                 # è¾“å‡ºæŠ½è±¡åŸºç±»
â”‚   â”‚   â”‚                           #   - class BaseOutput(ABC):
â”‚   â”‚   â”‚                           #     - async send(target, content, format) â†’ SendResult
â”‚   â”‚   â”‚                           #   - SendResult: success, channel, error_msg
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ router.py               # è¾“å‡ºè·¯ç”±
â”‚   â”‚   â”‚                           #   - dispatch(output_config, content) â†’ list[SendResult]
â”‚   â”‚   â”‚                           #   - output_config: {"type": "feishu", "target": "xxx"}
â”‚   â”‚   â”‚                           #   - æ”¯æŒå¤šç›®æ ‡: åŒæ—¶å‘é£ä¹¦ + webhook
â”‚   â”‚   â”‚                           #   - æŒ‰ type å­—æ®µè·¯ç”±åˆ°å¯¹åº” output å®ç°
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ feishu.py               # é£ä¹¦è¾“å‡º
â”‚   â”‚   â”‚                           #   - send_text(chat_id, text) â†’ çº¯æ–‡æœ¬
â”‚   â”‚   â”‚                           #   - send_card(chat_id, card) â†’ äº¤äº’å¡ç‰‡
â”‚   â”‚   â”‚                           #   - send_reply(message_id, text) â†’ å›å¤æ¶ˆæ¯
â”‚   â”‚   â”‚                           #   - å†…éƒ¨ç®¡ç† tenant_access_token åˆ·æ–°
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ webhook.py              # é€šç”¨ Webhook è¾“å‡º
â”‚   â”‚   â”‚                           #   - send(url, payload, headers) â†’ POST åˆ°ä»»æ„ URL
â”‚   â”‚   â”‚                           #   - æ”¯æŒè‡ªå®šä¹‰ payload æ¨¡æ¿
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ email.py                # é‚®ä»¶è¾“å‡º (å¯é€‰)
â”‚   â”‚                               #   - send(to, subject, body) â†’ SMTP å‘é€
â”‚   â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ API è·¯ç”±å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚   â”‚  (HTTP å…¥å£ï¼Œå‚æ•°æ ¡éªŒåå§”æ‰˜ç»™ core/scheduler å¤„ç†)
â”‚   â”‚
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ deps.py                 # å…¬å…±ä¾èµ–æ³¨å…¥
â”‚   â”‚   â”‚                           #   - get_db() â†’ AsyncSession
â”‚   â”‚   â”‚                           #   - get_current_user() â†’ User (ä» header/token æå–)
â”‚   â”‚   â”‚                           #   - get_llm_client() â†’ LLMClient
â”‚   â”‚   â”‚                           #   - get_memory() â†’ MemoryManager
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ chat.py                 # å¯¹è¯ API
â”‚   â”‚   â”‚                           #   - POST /api/chat          â†’ æ™®é€šå¯¹è¯
â”‚   â”‚   â”‚                           #   - POST /api/chat/stream   â†’ SSE æµå¼å¯¹è¯
â”‚   â”‚   â”‚                           #   - GET  /api/conversations â†’ å¯¹è¯åˆ—è¡¨
â”‚   â”‚   â”‚                           #   - GET  /api/conversations/{id}/messages â†’ å†å²æ¶ˆæ¯
â”‚   â”‚   â”‚                           #   - DELETE /api/conversations/{id}       â†’ åˆ é™¤å¯¹è¯
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ tasks.py                # å®šæ—¶ä»»åŠ¡ API
â”‚   â”‚   â”‚                           #   - POST   /api/tasks           â†’ åˆ›å»º (æ”¯æŒè‡ªç„¶è¯­è¨€)
â”‚   â”‚   â”‚                           #   - GET    /api/tasks           â†’ ä»»åŠ¡åˆ—è¡¨
â”‚   â”‚   â”‚                           #   - GET    /api/tasks/{id}      â†’ ä»»åŠ¡è¯¦æƒ…
â”‚   â”‚   â”‚                           #   - PUT    /api/tasks/{id}      â†’ æ›´æ–°ä»»åŠ¡é…ç½®
â”‚   â”‚   â”‚                           #   - DELETE /api/tasks/{id}      â†’ åˆ é™¤ä»»åŠ¡
â”‚   â”‚   â”‚                           #   - POST   /api/tasks/{id}/run  â†’ æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡
â”‚   â”‚   â”‚                           #   - GET    /api/tasks/{id}/logs â†’ æ‰§è¡Œæ—¥å¿—
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ memory.py               # è®°å¿†ç®¡ç† API
â”‚   â”‚   â”‚                           #   - GET    /api/memories        â†’ è®°å¿†åˆ—è¡¨ (åˆ†é¡µ+åˆ†ç±»)
â”‚   â”‚   â”‚                           #   - POST   /api/memories/search â†’ è¯­ä¹‰æœç´¢è®°å¿†
â”‚   â”‚   â”‚                           #   - DELETE /api/memories/{id}   â†’ åˆ é™¤é”™è¯¯è®°å¿†
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ admin.py                # ç®¡ç† API
â”‚   â”‚                               #   - GET  /api/admin/models     â†’ å¯ç”¨æ¨¡å‹åˆ—è¡¨
â”‚   â”‚                               #   - POST /api/admin/models/default â†’ è®¾ç½®é»˜è®¤æ¨¡å‹
â”‚   â”‚                               #   - GET  /api/admin/stats      â†’ ç”¨é‡ç»Ÿè®¡ (token/è´¹ç”¨)
â”‚   â”‚                               #   - GET  /api/admin/health     â†’ å¥åº·æ£€æŸ¥
â”‚   â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ä¸­é—´ä»¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚   â”‚
â”‚   â””â”€â”€ middleware/
â”‚       â”œâ”€â”€ logging.py              # è¯·æ±‚æ—¥å¿—
â”‚       â”‚                           #   - è®°å½•: method, path, status, latency
â”‚       â”‚                           #   - structlog æ ¼å¼åŒ–è¾“å‡º (JSON)
â”‚       â”‚
â”‚       â”œâ”€â”€ error_handler.py        # å…¨å±€å¼‚å¸¸å¤„ç†
â”‚       â”‚                           #   - LLMError â†’ 502 (ä¸Šæ¸¸æ¨¡å‹é”™è¯¯)
â”‚       â”‚                           #   - ToolError â†’ 500 (å·¥å…·æ‰§è¡Œå¤±è´¥)
â”‚       â”‚                           #   - ValidationError â†’ 422
â”‚       â”‚                           #   - ç»Ÿä¸€ ErrorResponse æ ¼å¼
â”‚       â”‚
â”‚       â””â”€â”€ auth.py                 # è®¤è¯ (ç®€å•å®ç°)
â”‚                                   #   - API Key è®¤è¯: X-API-Key header
â”‚                                   #   - é£ä¹¦æ¸ é“: ç­¾åéªŒè¯
â”‚                                   #   - å•ç”¨æˆ·åœºæ™¯å¯ç®€åŒ–ä¸ºå›ºå®š token
â”‚
â”‚  ======================== MCP å·¥å…·æœåŠ¡ ========================
â”‚  (æ¯ä¸ªå·¥å…·æ˜¯ç‹¬ç«‹çš„ MCP Serverï¼Œé€šè¿‡ stdio/SSE ä¸ä¸»åº”ç”¨é€šä¿¡)
â”‚
â”œâ”€â”€ mcp_servers/
â”‚   â”œâ”€â”€ web_search/
â”‚   â”‚   â”œâ”€â”€ server.py               # MCP Server å…¥å£
â”‚   â”‚   â””â”€â”€ pyproject.toml          # ç‹¬ç«‹ä¾èµ– (å¦‚ requests, serpapi)
â”‚   â”œâ”€â”€ stock_analysis/
â”‚   â”‚   â”œâ”€â”€ server.py
â”‚   â”‚   â””â”€â”€ pyproject.toml
â”‚   â””â”€â”€ _template/                  # æ–°å»ºå·¥å…·çš„æ¨¡æ¿
â”‚       â”œâ”€â”€ server.py
â”‚       â””â”€â”€ pyproject.toml
â”‚
â”‚  ======================== å‰ç«¯ (å¯é€‰) ========================
â”‚
â”œâ”€â”€ web/
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”‚   â”œâ”€â”€ Chat.tsx            # å¯¹è¯é¡µé¢
â”‚   â”‚   â”‚   â”œâ”€â”€ Tasks.tsx           # å®šæ—¶ä»»åŠ¡ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ Memory.tsx          # è®°å¿†æµè§ˆ
â”‚   â”‚   â”‚   â””â”€â”€ Settings.tsx        # æ¨¡å‹/æ¸ é“é…ç½®
â”‚   â”‚   â””â”€â”€ components/
â”‚   â”‚       â”œâ”€â”€ MessageBubble.tsx
â”‚   â”‚       â”œâ”€â”€ TaskCard.tsx
â”‚   â”‚       â””â”€â”€ MemoryItem.tsx
â”‚   â””â”€â”€ ...
â”‚
â”‚  ======================== æµ‹è¯• ========================
â”‚
â””â”€â”€ tests/
    â”œâ”€â”€ conftest.py                 # pytest fixtures: test db, mock llm, mock mcp
    â”œâ”€â”€ unit/
    â”‚   â”œâ”€â”€ test_chat.py            # å¯¹è¯ç¼–æ’é€»è¾‘
    â”‚   â”œâ”€â”€ test_memory.py          # è®°å¿†æ£€ç´¢/æ›´æ–°
    â”‚   â”œâ”€â”€ test_nl_parser.py       # è‡ªç„¶è¯­è¨€â†’cron è§£æ
    â”‚   â””â”€â”€ test_task_runner.py     # ä»»åŠ¡æ‰§è¡Œ
    â”œâ”€â”€ integration/
    â”‚   â”œâ”€â”€ test_api_chat.py        # èŠå¤© API ç«¯åˆ°ç«¯
    â”‚   â”œâ”€â”€ test_api_tasks.py       # ä»»åŠ¡ API ç«¯åˆ°ç«¯
    â”‚   â””â”€â”€ test_scheduler.py       # è°ƒåº¦å™¨é›†æˆæµ‹è¯•
    â””â”€â”€ fixtures/
        â””â”€â”€ sample_conversations.json
```

### å„å±‚è°ƒç”¨å…³ç³»

```
è¯·æ±‚æµå‘ (ä»¥é£ä¹¦æ¶ˆæ¯ä¸ºä¾‹):

  é£ä¹¦ â†’ channels/feishu.py (è§£æ/éªŒç­¾)
           â†’ InternalMessage
              â†’ core/intent.py (æ„å›¾è¯†åˆ«)
                 â”œâ”€ CHAT â†’ core/chat.py
                 â”‚          â†’ core/memory.py (recall)
                 â”‚          â†’ core/prompt.py (æ„å»º prompt)
                 â”‚          â†’ core/llm.py (è°ƒæ¨¡å‹)
                 â”‚          â†’ core/tools.py (æ‰§è¡Œå·¥å…·, å¦‚æœ‰)
                 â”‚          â†’ core/memory.py (process, å¼‚æ­¥)
                 â”‚          â†’ output/feishu.py (å›å¤)
                 â”‚
                 â””â”€ CREATE_TASK â†’ scheduler/nl_parser.py (è§£æ)
                                â†’ scheduler/engine.py (æ³¨å†Œ)
                                â†’ output/feishu.py (ç¡®è®¤å›å¤)

å®šæ—¶ä»»åŠ¡è§¦å‘:

  APScheduler trigger
    â†’ scheduler/task_runner.py
       â†’ core/memory.py (recall)
       â†’ core/prompt.py (æ„å»º prompt)
       â†’ core/llm.py (è°ƒæ¨¡å‹)
       â†’ core/tools.py (æ‰§è¡Œå·¥å…·)
       â†’ output/router.py â†’ output/feishu.py (å‘é€ç»“æœ)
       â†’ models/task_execution.py (è®°å½•æ—¥å¿—)
```

---

## å…­ã€å®ç°ä¼˜å…ˆçº§ (åˆ†é˜¶æ®µ)

### Phase 1: æ ¸å¿ƒå¯¹è¯ (1-2 å‘¨)
- [ ] FastAPI é¡¹ç›®éª¨æ¶ + Docker Compose (PostgreSQL + LiteLLM)
- [ ] LiteLLM é…ç½®å¤šæ¨¡å‹ (Claude/GPT/æœ¬åœ°)
- [ ] åŸºç¡€å¯¹è¯ API (æµå¼å“åº”)
- [ ] æ¶ˆæ¯æŒä¹…åŒ–
- [ ] ç®€å• Web èŠå¤©é¡µé¢

### Phase 2: è®°å¿† + å·¥å…· (1-2 å‘¨)
- [ ] é›†æˆ Mem0 (self-hosted, pgvector åç«¯)
- [ ] å¯¹è¯åè‡ªåŠ¨æå–/æ›´æ–°è®°å¿†
- [ ] å¯¹è¯å‰è®°å¿†æ£€ç´¢æ³¨å…¥
- [ ] MCP å·¥å…·æ¡†æ¶æ­å»º
- [ ] æ¥å…¥ 1-2 ä¸ªå·¥å…· (Webæœç´¢ã€å¤©æ°”ç­‰)

### Phase 3: å®šæ—¶ä»»åŠ¡ (1 å‘¨)
- [ ] APScheduler å¼•æ“ + PostgreSQL æŒä¹…åŒ–
- [ ] è‡ªç„¶è¯­è¨€â†’cron è§£æ (LLM function calling)
- [ ] ä»»åŠ¡ CRUD API
- [ ] ä»»åŠ¡æ‰§è¡Œå™¨ (è°ƒç”¨ LLM + å·¥å…· + è¾“å‡ºè·¯ç”±)
- [ ] æ‰§è¡Œæ—¥å¿—è®°å½•

### Phase 4: é£ä¹¦é›†æˆ (1 å‘¨)
- [ ] é£ä¹¦ Bot æ¶ˆæ¯æ¥æ”¶ (äº‹ä»¶è®¢é˜…)
- [ ] é£ä¹¦æ¶ˆæ¯å‘é€ (æ–‡æœ¬/å¡ç‰‡)
- [ ] å®šæ—¶ä»»åŠ¡ç»“æœæ¨é€é£ä¹¦
- [ ] é£ä¹¦å†…ç®¡ç†å®šæ—¶ä»»åŠ¡

### Phase 5: æ‰“ç£¨ (æŒç»­)
- [ ] ç®¡ç†åå° (æ¨¡å‹åˆ‡æ¢ã€ä»»åŠ¡ç®¡ç†ã€è®°å¿†æµè§ˆ)
- [ ] æ›´å¤š MCP å·¥å…·
- [ ] æ›´å¤šè¾“å‡ºæ¸ é“
- [ ] ç›‘æ§ä¸å‘Šè­¦

---

## ä¸ƒã€éƒ¨ç½²æ–¹æ¡ˆ

### Docker Compose

```yaml
version: "3.8"
services:
  postgres:
    image: pgvector/pgvector:pg16
    volumes:
      - pgdata:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: k_assistant
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    ports:
      - "5432:5432"

  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    volumes:
      - ./litellm_config.yaml:/app/config.yaml
    ports:
      - "4000:4000"
    command: --config /app/config.yaml

  app:
    build: .
    depends_on:
      - postgres
      - litellm
    ports:
      - "8000:8000"
    environment:
      DATABASE_URL: postgresql://postgres:${DB_PASSWORD}@postgres/k_assistant
      LITELLM_URL: http://litellm:4000
      FEISHU_APP_ID: ${FEISHU_APP_ID}
      FEISHU_APP_SECRET: ${FEISHU_APP_SECRET}
    volumes:
      - ./mcp_servers:/app/mcp_servers

volumes:
  pgdata:
```

### ç¡¬ä»¶éœ€æ±‚ (ä»…äº‘ç«¯ LLM)
- **CPU**: 4 æ ¸
- **å†…å­˜**: 8 GB
- **ç£ç›˜**: 100 GB SSD
- **ç½‘ç»œ**: éœ€è¦è®¿é—®å¤–ç½‘ (LLM API)

---

## å…«ã€å¤‡é€‰æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚åˆåœºæ™¯ |
|------|------|------|----------|
| **æ–¹æ¡ˆA: è‡ªç ”æ ¸å¿ƒ** (æ¨è) | å®Œå…¨å¯æ§ï¼Œçµæ´»åº¦æœ€é«˜ï¼Œè½»é‡ | å¼€å‘é‡è¾ƒå¤§ | å¯¹çµæ´»æ€§å’Œå®šåˆ¶åŒ–æœ‰è¦æ±‚ |
| **æ–¹æ¡ˆB: Dify + æ’ä»¶** | å¼€ç®±å³ç”¨çš„å·¥ä½œæµ+RAG+å®šæ—¶ä»»åŠ¡ | 11ä¸ªå®¹å™¨è¾ƒé‡ï¼Œå®šåˆ¶å—é™ï¼Œè®°å¿†è¾ƒå¼± | å¿«é€ŸåŸå‹éªŒè¯ |
| **æ–¹æ¡ˆC: n8n + AIèŠ‚ç‚¹** | æœ€å¼ºé›†æˆèƒ½åŠ›ï¼Œ400+å·¥å…·èŠ‚ç‚¹ | ä¸æ˜¯ AI-firstï¼Œå¯¹è¯ä½“éªŒå¼± | é‡å·¥ä½œæµè‡ªåŠ¨åŒ–åœºæ™¯ |
| **æ–¹æ¡ˆD: OpenClaw** | æè½»éƒ¨ç½²ï¼ŒåŸç”Ÿå¤šæ¸ é“+å®šæ—¶ | ç›¸å¯¹è¾ƒæ–°ï¼Œç”Ÿæ€å¾…éªŒè¯ | å¿«é€Ÿä¸Šçº¿å¤šæ¸ é“ Bot |

**æ¨èæ–¹æ¡ˆA**ï¼ŒåŸå› :
1. å››ä¸ªéœ€æ±‚éƒ½éœ€è¦æ·±åº¦å®šåˆ¶ï¼ˆç‰¹åˆ«æ˜¯è®°å¿†å’Œå®šæ—¶ä»»åŠ¡çš„è”åŠ¨ï¼‰
2. ç»„ä»¶çº§å¤ç”¨æˆç†Ÿæ–¹æ¡ˆï¼ˆMem0ã€LiteLLMã€APSchedulerï¼‰ï¼Œä¸æ˜¯ä»é›¶é€ è½®å­
3. å•æœºéƒ¨ç½²åªéœ€ 3 ä¸ª Docker å®¹å™¨ï¼ˆapp + postgres + litellmï¼‰ï¼Œèµ„æºå ç”¨ä½
4. æœªæ¥å¯ä»¥çµæ´»æ›¿æ¢ä»»ä½•ç»„ä»¶
